name: Queue Main to OLTP Sync

on:
  workflow_run:
    workflows:
      - Dev
      - Lint and Prettier
      - Package
      - CodeQL
    types:
      - completed

permissions:
  actions: read
  contents: write

concurrency:
  group: queue-main-to-oltp-${{ github.event.workflow_run.head_sha }}
  cancel-in-progress: true

jobs:
  dispatch:
    name: Dispatch Sync Runner
    if: >-
      github.event.workflow_run.event == 'push' &&
      github.event.workflow_run.head_branch == 'main'
    runs-on: ubuntu-latest
    steps:
      - name: Check required workflow results
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            const requiredWorkflows = [
              'Dev',
              'Lint and Prettier',
              'Package',
              'CodeQL',
            ]

            const { owner, repo } = context.repo
            const headSha = context.payload.workflow_run.head_sha
            const headBranch = context.payload.workflow_run.head_branch

            const runs = await github.paginate(
              github.rest.actions.listWorkflowRunsForRepo,
              {
                owner,
                repo,
                branch: headBranch,
                event: 'push',
                head_sha: headSha,
                per_page: 100,
              }
            )

            const latestRunsByName = new Map()

            for (const run of runs) {
              if (!requiredWorkflows.includes(run.name)) {
                continue
              }

              const previousRun = latestRunsByName.get(run.name)

              if (
                !previousRun ||
                run.run_attempt > previousRun.run_attempt ||
                (
                  run.run_attempt === previousRun.run_attempt &&
                  new Date(run.updated_at) > new Date(previousRun.updated_at)
                )
              ) {
                latestRunsByName.set(run.name, run)
              }
            }

            const pending = []
            const failed = []

            core.summary.addHeading('Main-to-OLTP Sync Gate')
            core.summary.addRaw(`Commit: \`${headSha}\`\n\n`)

            for (const workflowName of requiredWorkflows) {
              const run = latestRunsByName.get(workflowName)

              if (!run) {
                pending.push(workflowName)
                core.summary.addRaw(`- ${workflowName}: missing\n`)
                continue
              }

              core.summary.addRaw(
                `- ${workflowName}: ${run.status}/${run.conclusion ?? 'n/a'} ` +
                `(attempt ${run.run_attempt})\n`
              )

              if (run.status !== 'completed') {
                pending.push(workflowName)
                continue
              }

              if (run.conclusion !== 'success') {
                failed.push(workflowName)
              }
            }

            await core.summary.write()

            if (pending.length > 0 || failed.length > 0) {
              core.info(
                `Skipping dispatch for ${headSha}. ` +
                `Pending: ${pending.join(', ') || 'none'}. ` +
                `Failed: ${failed.join(', ') || 'none'}.`
              )
              core.setOutput('ready', 'false')
              return
            }

            core.setOutput('ready', 'true')
            core.setOutput('head_sha', headSha)

      - name: Dispatch sync workflow
        if: steps.check.outputs.ready == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.repos.createDispatchEvent({
              owner: context.repo.owner,
              repo: context.repo.repo,
              event_type: 'sync-main-to-oltp',
              client_payload: {
                main_sha: '${{ steps.check.outputs.head_sha }}',
              },
            })
